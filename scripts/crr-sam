#!/usr/bin/env bash

set -euo pipefail


action="$1"
shift

case "$action" in
  deploy)
    ;;
  destroy)
    ;;
  *)
    echo "Unknown action: $action"
    exit 1
    ;;
esac

# This script accepts a list of tests names from Check Run Reporter, filters
# them down to just examples, and then deploys those stacks

deployed=''

for testfile in "$@"; do
  if [[ ! "$testfile" =~ ^examples/ ]]; then
    echo "Skipping $testfile which does not appear to test an AWS stack"
    continue
  fi

  example=$(echo "$testfile" | awk -F/ '{print $2}')

  suffix="${GITHUB_SHA:0:7}"
  stack_name="$example-$suffix"

  STACK_NAME="$stack_name" ./scripts/sam "$action" aws "$example"

  deployed="$deployed $testfile"
done

if [ -z "$deployed" ]; then
  echo "::error title=CI Misconfiguration::No stacks deployed"
  exit 1
fi

echo "deployed=$deployed" >> "$GITHUB_OUTPUT"
